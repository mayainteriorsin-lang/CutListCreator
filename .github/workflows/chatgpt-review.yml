- name: Run ChatGPT review
  run: |
    # Safe fallback diff – avoids HEAD~1 failure
    changes=$(git diff HEAD^ HEAD 2>/dev/null || echo "No previous commit")

    echo "Changes detected:"
    echo "$changes"

    echo "Sending to OpenAI…"

    review=$(curl -s https://api.openai.com/v1/chat/completions \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
      -d "{
        \"model\": \"gpt-4o-mini\",
        \"messages\": [
          {\"role\": \"system\", \"content\": \"You are a senior full-stack engineer. Review the following code diff for bugs, security issues, performance problems, and improvements.\"},
          {\"role\": \"user\", \"content\": \"$changes\"}
        ]
      }" | jq -r '.choices[0].message.content')

    echo "Review output:"
    echo "$review"
